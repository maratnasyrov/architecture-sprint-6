# Предложение по обновлению архитектуры

Исходя из требований, предлагаю следующую технологическую архитектуру, которая расширяет текущую инфраструктуру для удовлетворения новых бизнес-потребностей.

## 1. Географически распределенная инфраструктура

Мульти-региональное развертывание:

- Добавление дополнительных регионов: Развертывание дополнительных Kubernetes кластеров и баз данных PostgreSQL в разных регионах РФ (например, Москва, Екатеринбург, Новосибирск).
- Балансировка нагрузки: Использование глобального балансировщика нагрузки для распределения трафика между региональными кластерами на основе геолокации пользователя.

## 2. Высокая доступность и отказоустойчивость

Базы данных PostgreSQL:

- Кластеризация: Переход от одиночной базы данных на VM 1 к кластеру PostgreSQL с репликацией.
- Синхронная репликация внутри региона: Обеспечение отказоустойчивости в пределах каждого региона.
- Асинхронная репликация между регионами: Для достижения RPO в 15 минут.

Kubernetes кластеры:

- Развертывание в нескольких зонах доступности: Каждый кластер охватывает несколько зон для повышенной устойчивости.
- Автоматическое восстановление: Настройка механизмов авто-восстановления подов и сервисов при сбоях.

## 3. Обеспечение одинакового времени загрузки страниц

CDN для статического контента:

- Внедрение CDN: Использование сети доставки контента для ускорения загрузки статических ресурсов.

Локализация сервисов:

- Региональные развертывания приложений: Размещение копий сервисов в каждом регионе для уменьшения задержек.

## 4. Масштабируемость и производительность

Горизонтальное масштабирование:

- Авто-масштабирование подов: Настройка Horizontal Pod Autoscaler (HPA) в Kubernetes на основе метрик нагрузки.

Оптимизация базы данных:

- Разделение нагрузки: Использование реплик для чтения и мастеров для записи.

## 5. Обновленная схема архитектуры

Пользовательский доступ

- Браузер пользователя обращается к сервису через интернет.
- Глобальный балансировщик нагрузки направляет запросы в ближайший региональный кластер.

Региональные кластеры Kubernetes

- Kubernetes Сluster содержит:
- Namespace “InsureTech”, где развернуты приложения:
  - core-app
  - client-info
  - ins-product-aggregator
  - ins-comp-settlement
- Ingress Controller управляет входящими запросами.
- Соединение с PostgreSQL: Приложения подключаются к базе данных через TCP.

Базы данных PostgreSQL

- Кластер PostgreSQL в каждом регионе:
- Мастер и реплики для высокой доступности.
- Репликация данных между регионами.

Взаимодействие между компонентами

- Сервисы внутри Kubernetes взаимодействуют через внутреннюю сеть.
- Внешние системы (партнеры, страховые компании) подключаются через защищенные каналы.

## 6. Failover-стратегия

Выбранная стратегия: Active-Active

- Причины выбора:
  - Обеспечение непрерывности сервиса и минимизация времени простоя.
  - Повышение производительности и снижение задержек для пользователей из разных регионов.
  - Возможность равномерного распределения нагрузки между кластерами.

## 7. Тип репликации баз данных

Выбранный тип репликации: Master-Master (Multi-Master)

- Причины выбора:
  - Необходимо обеспечить локальные операции записи и чтения в каждом регионе для снижения задержек.
  - Повышение отказоустойчивости: при выходе из строя одного узла другие продолжают полнофункциональную работу.
  - Возможность масштабирования операций записи.

Реализация:

- Использование PostgreSQL с расширениями для Multi-Master репликации:
- BDR (Bi-Directional Replication) или Postgres-BDR:
- Позволяет настроить асинхронную репликацию между несколькими мастерами.
- Обеспечивает разрешение конфликтов и консистентность данных.
- Синхронная репликация внутри региона:
- В каждом регионе настроена синхронная репликация между узлами для обеспечения высокой доступности и консистентности данных.
- Асинхронная репликация между регионами:
- Для уменьшения задержек и обеспечения RPO в 15 минут данные реплицируются асинхронно между регионами.

## 8. Мониторинг и алертинг

Мониторинг:

- Prometheus и Grafana: Сбор и визуализация метрик со всех регионов.
- Алертинг: Настройка оповещений при отклонениях в работе системы.

Логирование:

- Централизованное логирование: Использование ELK Stack для сбора и анализа логов.

## 9. Обеспечение RTO, RPO и доступности

- Доступность 99,9%: Достигается за счет распределенной инфраструктуры и отказоустойчивости.
- RPO (15 минут): Обеспечивается асинхронной репликацией между регионами.
- RTO (45 минут): Достигается автоматизированными процессами восстановления.

Преимущества обновленной архитектуры

- Высокая отказоустойчивость: Система устойчива к сбоям в отдельных зонах или регионах.
- Масштабируемость: Готовность к увеличению нагрузки и объемов данных.
- Быстрый отклик: Минимизация задержек для пользователей по всей России.
- Соответствие бизнес-требованиям: Полное удовлетворение требований по доступности и восстановлению.

Заключение

Предложенные изменения в технологической архитектуре позволят InsureTech успешно расширить свою деятельность на регионы РФ, обеспечивая высокое качество сервиса и удовлетворение потребностей бизнеса. Реализация данной архитектуры создаст прочную основу для дальнейшего роста и развития компании.
